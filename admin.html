<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | DigitalServicesHub</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .loader { border: 2px solid #f3f3f3; border-radius: 50%; border-top: 2px solid #3b82f6; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans antialiased flex h-screen overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0 transition-all duration-300 z-20" id="sidebar">
        <div class="h-16 flex items-center px-6 border-b border-slate-800">
            <div class="flex items-center gap-2">
                <div class="bg-brand-600 p-1.5 rounded text-white"><i data-lucide="cpu" class="w-5 h-5"></i></div>
                <span class="text-lg font-bold font-heading tracking-tight">DSH Admin</span>
            </div>
        </div>

        <nav class="flex-1 overflow-y-auto py-4 px-3 space-y-1">
            <button onclick="switchView('dashboard')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 hover:text-white transition-colors active bg-slate-800 text-white">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
            </button>
            <button onclick="switchView('inbox')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                <i data-lucide="inbox" class="w-5 h-5"></i> Inbox
                <span class="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden" id="inbox-badge">0</span>
            </button>
            <button onclick="switchView('subscribers')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                <i data-lucide="mail" class="w-5 h-5"></i> Subscribers
            </button>
            
            <div class="my-2 border-t border-slate-800"></div>
            
            <button onclick="switchView('banners')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                <i data-lucide="megaphone" class="w-5 h-5"></i> Ad Banners
            </button>
            <button onclick="switchView('posts')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                <i data-lucide="file-text" class="w-5 h-5"></i> Blog Posts
            </button>
            <button onclick="switchView('prompts')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                <i data-lucide="terminal" class="w-5 h-5"></i> AI Prompts
            </button>
            <button onclick="switchView('comments')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                <i data-lucide="message-square" class="w-5 h-5"></i> Comments
                <span class="ml-auto bg-brand-600 text-white text-xs font-bold px-2 py-0.5 rounded-full" id="comment-badge">0</span>
            </button>
            <button onclick="switchView('keys')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                <i data-lucide="key" class="w-5 h-5"></i> API Keys
            </button>
             <button onclick="switchView('logs')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                <i data-lucide="activity" class="w-5 h-5"></i> Audit Logs
            </button>
            <button onclick="switchView('settings')" class="nav-item w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-slate-300 hover:bg-slate-800 hover:text-white transition-colors">
                <i data-lucide="settings" class="w-5 h-5"></i> Settings
            </button>
        </nav>

        <div class="p-4 border-t border-slate-800">
            <button onclick="logout()" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-red-400 hover:bg-slate-800 hover:text-red-300 transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-slate-50">
        
        <!-- Top Header -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 lg:px-8 z-10">
            <button id="toggle-sidebar" class="lg:hidden text-slate-500 hover:text-slate-700">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <div class="flex items-center gap-4 ml-auto">
                <div id="db-status" class="flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-50 text-yellow-700 text-xs font-medium border border-yellow-200">
                    <div class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div> Connecting DB...
                </div>
                <button class="relative p-2 text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white"></span>
                </button>
                <div class="flex items-center gap-3 pl-4 border-l border-slate-200">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-bold text-slate-900">Admin User</p>
                        <p class="text-xs text-slate-500">Super Admin</p>
                    </div>
                    <img src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?q=80&w=100&auto=format&fit=crop" alt="Admin" class="w-9 h-9 rounded-full border border-slate-200">
                </div>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6 lg:p-8" id="main-container">
            
            <!-- DASHBOARD VIEW -->
            <div id="view-dashboard" class="view-section animate-fade-in">
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">Realtime Dashboard</h1>
                        <p class="text-slate-500 mt-1">Live metrics from Firestore.</p>
                    </div>
                    <div class="flex gap-2">
                        <span class="text-sm text-slate-500 bg-white px-3 py-1 rounded border border-slate-200 shadow-sm flex items-center gap-2">
                             Last 7 Days
                        </span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-brand-50 text-brand-600 rounded-lg"><i data-lucide="inbox" class="w-6 h-6"></i></div>
                             <span class="text-xs font-bold text-green-600 bg-green-50 px-2 py-1 rounded">New</span>
                        </div>
                        <h3 class="text-3xl font-bold text-slate-900" id="stats-total-inbox">0</h3>
                        <p class="text-sm text-slate-500 mt-1">Support Messages</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-purple-50 text-purple-600 rounded-lg"><i data-lucide="file-text" class="w-6 h-6"></i></div>
                        </div>
                        <h3 class="text-3xl font-bold text-slate-900" id="stats-total-posts">0</h3>
                        <p class="text-sm text-slate-500 mt-1">Published Posts</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-orange-50 text-orange-600 rounded-lg"><i data-lucide="message-circle" class="w-6 h-6"></i></div>
                        </div>
                        <h3 class="text-3xl font-bold text-slate-900" id="stats-total-comments">0</h3>
                        <p class="text-sm text-slate-500 mt-1">Total Comments</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><i data-lucide="megaphone" class="w-6 h-6"></i></div>
                             <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded">Live</span>
                        </div>
                        <h3 class="text-3xl font-bold text-slate-900" id="stats-active-banners">0</h3>
                        <p class="text-sm text-slate-500 mt-1">Active Banners</p>
                    </div>
                </div>

                <div class="grid lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-900 mb-4">Content Activity</h3>
                        <div class="relative h-64 w-full">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-slate-900 mb-4">Content Breakdown</h3>
                         <div class="relative h-64 w-full flex justify-center">
                             <canvas id="contentChart"></canvas>
                         </div>
                    </div>
                </div>
            </div>

            <!-- AUDIT LOGS VIEW (New) -->
            <div id="view-logs" class="view-section hidden animate-fade-in">
                <h1 class="text-2xl font-bold text-slate-900 mb-2">Audit Logs</h1>
                <p class="text-slate-500 text-sm mb-6">Track admin activities and system changes.</p>
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">Action</th>
                                <th class="px-6 py-4">Details</th>
                                <th class="px-6 py-4">Admin</th>
                                <th class="px-6 py-4">Date</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200" id="logs-table-body">
                            <!-- Logs Injected Here -->
                        </tbody>
                    </table>
                </div>
            </div>

             <!-- BANNERS VIEW -->
            <div id="view-banners" class="view-section hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">Ad & Promo Banners</h1>
                        <p class="text-slate-500 text-sm mt-1">Manage site-wide notification bars and alerts.</p>
                    </div>
                    <button onclick="openBannerModal()" class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-brand-700 transition-colors flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> New Banner
                    </button>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">Content</th>
                                <th class="px-6 py-4">Color</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200" id="banners-table-body">
                             <!-- Banners Injected Here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- INBOX VIEW -->
            <div id="view-inbox" class="view-section hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">Inbox</h1>
                        <p class="text-slate-500 text-sm mt-1">Messages from the Contact Us page.</p>
                    </div>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">Name</th>
                                <th class="px-6 py-4">Subject</th>
                                <th class="px-6 py-4">Message</th>
                                <th class="px-6 py-4">Date</th>
                                <th class="px-6 py-4 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200" id="inbox-table-body">
                             <!-- Messages Injected Here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SUBSCRIBERS VIEW -->
            <div id="view-subscribers" class="view-section hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-slate-900">Newsletter Subscribers</h1>
                    <div class="flex gap-2">
                         <button onclick="exportData('subscribers')" class="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> CSV
                        </button>
                    </div>
                </div>
                 <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">Email</th>
                                <th class="px-6 py-4">Source</th>
                                <th class="px-6 py-4">Joined Date</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200" id="subscribers-table-body">
                             <!-- Subscribers Injected Here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- API KEYS VIEW -->
            <div id="view-keys" class="view-section hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">API Key Management</h1>
                        <p class="text-slate-500 text-sm mt-1">Manage Gemini API keys for load balancing.</p>
                    </div>
                    <button onclick="addKeyPrompt()" class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-brand-700 transition-colors flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Add Key
                    </button>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">Key Snippet</th>
                                <th class="px-6 py-4">Status</th>
                                <th class="px-6 py-4">Added Date</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200" id="keys-table-body">
                            <!-- Keys Injected Here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AI PROMPTS VIEW -->
            <div id="view-prompts" class="view-section hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-slate-900">System Prompts</h1>
                        <p class="text-slate-500 text-sm mt-1">Manage tool logic.</p>
                    </div>
                    <button onclick="saveAllPrompts()" class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-brand-700 transition-colors flex items-center gap-2" id="save-prompts-btn">
                        <i data-lucide="save" class="w-4 h-4"></i> Save Changes
                    </button>
                </div>

                <div class="grid lg:grid-cols-4 gap-6 h-[calc(100vh-240px)]">
                    <!-- Prompt Sidebar -->
                    <div class="lg:col-span-1 bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                        <div class="p-4 border-b border-slate-200 bg-slate-50">
                            <h3 class="font-bold text-slate-700 text-sm">Tools</h3>
                        </div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="prompts-nav"></div>
                    </div>

                    <!-- Prompt Editor -->
                    <div class="lg:col-span-3 bg-white rounded-xl border border-slate-200 shadow-sm flex flex-col">
                        <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                            <div>
                                <h3 class="font-bold text-slate-900" id="editor-title">Select a Tool</h3>
                                <p class="text-xs text-slate-500" id="editor-id">No tool selected</p>
                            </div>
                        </div>
                        <div class="flex-1 p-4 relative">
                            <textarea id="prompt-editor" class="w-full h-full p-4 border border-slate-200 rounded-lg font-mono text-sm text-slate-700 focus:ring-2 focus:ring-brand-500 outline-none resize-none bg-slate-50" placeholder="Select a tool from the left to edit its prompt..."></textarea>
                        </div>
                        <div class="p-4 border-t border-slate-200 bg-slate-50 text-xs text-slate-500 flex justify-between">
                            <span>Use <code class="bg-slate-200 px-1 rounded text-slate-700">${topic}</code> as the placeholder.</span>
                            <span id="last-updated">Last updated: Never</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- POSTS VIEW -->
            <div id="view-posts" class="view-section hidden animate-fade-in">
                 <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-slate-900">Blog Posts</h1>
                    <button onclick="openPostModal()" class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-brand-700 transition-colors flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> New Post
                    </button>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">Title</th>
                                <th class="px-6 py-4">Category</th>
                                <th class="px-6 py-4">Author</th>
                                <th class="px-6 py-4">Date</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200" id="posts-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- COMMENTS VIEW -->
            <div id="view-comments" class="view-section hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-slate-900">Comments</h1>
                </div>
                <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-200">
                            <tr>
                                <th class="px-6 py-4">User</th>
                                <th class="px-6 py-4">Comment</th>
                                <th class="px-6 py-4">Date</th>
                                <th class="px-6 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200" id="comments-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- USERS VIEW -->
            <div id="view-users" class="view-section hidden animate-fade-in">
                <h1 class="text-2xl font-bold text-slate-900 mb-6">User Management</h1>
                <div class="bg-white rounded-xl border border-slate-200 p-12 text-center">
                     <i data-lucide="users" class="w-12 h-12 text-slate-300 mx-auto mb-4"></i>
                     <p>User management coming soon.</p>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="view-settings" class="view-section hidden animate-fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-bold text-slate-900">Global Settings & SEO</h1>
                    <div class="flex gap-2">
                         <button onclick="exportData('backup')" class="bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 flex items-center gap-2">
                            <i data-lucide="database" class="w-4 h-4"></i> Backup All Data
                        </button>
                        <button onclick="saveSettings()" class="bg-brand-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-brand-700 transition-colors flex items-center gap-2" id="save-settings-btn">
                            <i data-lucide="save" class="w-4 h-4"></i> Save Settings
                        </button>
                    </div>
                </div>

                <div class="grid lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Site Metadata -->
                        <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2"><i data-lucide="globe" class="w-5 h-5 text-slate-500"></i> Site Identity</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Website Title</label>
                                    <input type="text" id="seo-title" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500" placeholder="DigitalServicesHub.online">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Meta Description</label>
                                    <textarea id="seo-desc" rows="3" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 resize-none" placeholder="Site description..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Keywords</label>
                                    <input type="text" id="seo-keywords" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500" placeholder="AI, Tools, SEO">
                                </div>
                                 <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Author</label>
                                    <input type="text" id="seo-author" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500" placeholder="Admin">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analytics & Verification -->
                        <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2"><i data-lucide="bar-chart-3" class="w-5 h-5 text-slate-500"></i> Analytics & Verification</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Google Analytics Script</label>
                                    <textarea id="seo-analytics-id" rows="3" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 font-mono text-xs" placeholder="<!-- Global site tag (gtag.js) -->..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Google Search Console Verification</label>
                                    <input type="text" id="seo-search-console" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 font-mono text-xs" placeholder='<meta name="google-site-verification" content="..." />'>
                                </div>
                            </div>
                        </div>

                        <!-- Ad Configuration -->
                        <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2"><i data-lucide="dollar-sign" class="w-5 h-5 text-slate-500"></i> Ad Configuration</h3>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Google AdSense Script (Global)</label>
                                <textarea id="ads-adsense" rows="3" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 font-mono text-xs" placeholder='<script async src="..."></script>'></textarea>
                            </div>

                            <h4 class="text-sm font-bold text-slate-700 mb-3">Adsterra Scripts</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">160x300 (Skyscraper)</label>
                                    <textarea id="ads-adsterra-160x300" rows="3" class="w-full p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 font-mono text-xs"></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">160x600 (Wide Skyscraper)</label>
                                    <textarea id="ads-adsterra-160x600" rows="3" class="w-full p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 font-mono text-xs"></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">300x250 (Rectangle)</label>
                                    <textarea id="ads-adsterra-300x250" rows="3" class="w-full p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 font-mono text-xs"></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">320x50 (Mobile Banner)</label>
                                    <textarea id="ads-adsterra-320x50" rows="3" class="w-full p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 font-mono text-xs"></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">728x90 (Leaderboard)</label>
                                    <textarea id="ads-adsterra-728x90" rows="3" class="w-full p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 font-mono text-xs"></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">468x60 (Full Banner)</label>
                                    <textarea id="ads-adsterra-468x60" rows="3" class="w-full p-2 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 font-mono text-xs"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Technical SEO -->
                        <div class="bg-white rounded-xl border border-slate-200 p-6 shadow-sm">
                            <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2"><i data-lucide="code" class="w-5 h-5 text-slate-500"></i> Technical SEO</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Sitemap URL</label>
                                    <input type="text" id="seo-sitemap" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">OG Image URL</label>
                                    <input type="text" id="seo-og-image" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Robots.txt</label>
                                    <textarea id="seo-robots" rows="4" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 font-mono text-xs"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Header Scripts</label>
                                    <textarea id="seo-scripts" rows="4" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500 font-mono text-xs"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                     <div class="lg:col-span-1 space-y-6">
                        <div class="bg-blue-50 border border-blue-100 rounded-xl p-6">
                            <h4 class="font-bold text-blue-800 mb-2">Status</h4>
                            <p class="text-sm text-blue-600 mb-4">Settings are synced real-time.</p>
                             <div class="flex items-center gap-2 text-xs text-blue-500"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Live</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>
    
    <!-- ADD/EDIT POST MODAL -->
    <div id="post-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closePostModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all scale-95 opacity-0" id="post-modal-content">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-900" id="modal-title">Create New Post</h3>
                    <button onclick="closePostModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="post-id">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
                        <input type="text" id="post-title" class="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                            <select id="post-category" class="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none bg-white">
                                <option>AI Tools</option>
                                <option>SEO</option>
                                <option>YouTube</option>
                                <option>Instagram</option>
                                <option>TikTok</option>
                                <option>Marketing</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Read Time</label>
                            <input type="text" id="post-readTime" class="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Image URL</label>
                        <input type="text" id="post-image" class="w-full p-2.5 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Content</label>
                        <textarea id="post-content" rows="10" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none font-mono text-sm"></textarea>
                    </div>
                </div>
                <div class="p-6 border-t border-slate-100 flex justify-end gap-3">
                    <button onclick="closePostModal()" class="px-4 py-2 border border-slate-200 rounded-lg text-slate-600 font-medium">Cancel</button>
                    <button onclick="savePost()" class="px-4 py-2 bg-brand-600 text-white rounded-lg font-medium">Save Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ADD/EDIT BANNER MODAL -->
    <div id="banner-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="closeBannerModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg transform transition-all scale-95 opacity-0" id="banner-modal-content">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-900" id="banner-modal-title">New Banner</h3>
                    <button onclick="closeBannerModal()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="p-6 space-y-4">
                    <input type="hidden" id="banner-id">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Banner Text</label>
                        <input type="text" id="banner-text" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500" placeholder="e.g., 50% Off Summer Sale">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Link URL (Optional)</label>
                        <input type="text" id="banner-link" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-brand-500" placeholder="https://...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Background Color</label>
                        <select id="banner-color" class="w-full p-2.5 border border-slate-200 rounded-lg outline-none bg-white">
                            <option value="bg-blue-600">Blue</option>
                            <option value="bg-green-600">Green</option>
                            <option value="bg-red-600">Red</option>
                            <option value="bg-purple-600">Purple</option>
                            <option value="bg-orange-500">Orange</option>
                            <option value="bg-slate-900">Black</option>
                        </select>
                    </div>
                     <div class="flex items-center gap-2">
                        <input type="checkbox" id="banner-active" class="w-4 h-4 text-brand-600 border-slate-300 rounded">
                        <label for="banner-active" class="text-sm font-medium text-slate-700">Active (Visible on site)</label>
                    </div>
                </div>
                <div class="p-6 border-t border-slate-100 flex justify-end gap-3">
                    <button onclick="closeBannerModal()" class="px-4 py-2 border border-slate-200 rounded-lg text-slate-600 font-medium">Cancel</button>
                    <button onclick="saveBanner()" class="px-4 py-2 bg-brand-600 text-white rounded-lg font-medium">Save Banner</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, getDoc, onSnapshot, addDoc, deleteDoc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify({
          apiKey: "AIzaSyBPyGJ_qX58Ye3Z8BTiKnYGNMYROnyHlGA",
          authDomain: "mubashir-2b7cc.firebaseapp.com",
          projectId: "mubashir-2b7cc",
          storageBucket: "mubashir-2b7cc.firebasestorage.app",
          messagingSenderId: "107494735119",
          appId: "1:107494735119:web:1fc0eab2bc0b8cb39e527a",
          measurementId: "G-SP28C45HH4"
        });
        const firebaseConfig = JSON.parse(firebaseConfigStr);

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mubashir-2b7cc';

        let apiKeys = [];
        let systemPrompts = {};
        let currentPromptId = null;
        let posts = [];
        let comments = [];
        let messages = [];
        let subscribers = [];
        let banners = [];
        let logs = []; // Audit Logs
        
        let activityChartInstance = null;
        let contentChartInstance = null;

        // Prompts Config
        const defaultPrompts = {
            'youtube_title': 'Generate 5 viral, high-CTR YouTube video titles for the topic: "${topic}". Return ONLY the titles as a numbered list.',
            'youtube_tags': 'Generate 20 high-volume YouTube SEO tags for the topic: "${topic}". Return them as a comma-separated list.',
            'insta_caption': 'Write 3 distinct Instagram captions for a post about: "${topic}". Include emojis.',
            'tiktok_hook': 'Generate 3 distinct, viral TikTok video hooks for the topic: "${topic}".',
            'blog_writer': 'Write a 1000-word, SEO-optimized blog post about: "${topic}". Use Markdown headings.',
            'email_subject': 'Generate 5 email subject lines for: "${topic}".',
            'twitter_thread': 'Write a 5-tweet viral X thread about: "${topic}".'
        };
        const toolNames = {
            'youtube_title': 'YouTube Titles', 'youtube_tags': 'YouTube Tags', 'insta_caption': 'IG Captions', 'tiktok_hook': 'TikTok Hooks', 'blog_writer': 'Blog Writer', 'email_subject': 'Email Subjects', 'twitter_thread': 'Twitter Thread'
        };

        // Init
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();
            initAdmin();
        });

        async function initAdmin() {
            const statusBadge = document.getElementById('db-status');
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                statusBadge.innerHTML = `<div class="w-2 h-2 rounded-full bg-green-500"></div> Online`;
                statusBadge.className = "flex items-center gap-2 px-3 py-1 rounded-full bg-green-50 text-green-700 text-xs font-medium border border-green-200";
                
                setupRealtimeListeners();
                loadSettings();

            } catch (error) {
                console.error("Auth Error:", error);
                statusBadge.innerHTML = `<div class="w-2 h-2 rounded-full bg-red-500"></div> Error`;
                statusBadge.className = "flex items-center gap-2 px-3 py-1 rounded-full bg-red-50 text-red-700 text-xs font-medium border border-red-200";
            }
        }

        function setupRealtimeListeners() {
            if (!auth.currentUser) return;

            // Keys
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'api_keys'), (snapshot) => {
                apiKeys = [];
                snapshot.forEach(doc => apiKeys.push({ id: doc.id, ...doc.data() }));
                renderKeysTable();
                document.getElementById('stats-keys').innerText = apiKeys.length;
            });

            // Prompts
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'system_prompts'), (snapshot) => {
                if (snapshot.empty) systemPrompts = { ...defaultPrompts };
                else {
                    systemPrompts = { ...defaultPrompts };
                    snapshot.forEach(doc => systemPrompts[doc.id] = doc.data().template);
                }
                renderPromptNav();
                document.getElementById('stats-prompts').innerText = Object.keys(systemPrompts).length;
            });

            // Posts
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), (snapshot) => {
                posts = [];
                snapshot.forEach((doc) => posts.push({ id: doc.id, ...doc.data() }));
                posts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                document.getElementById('stats-total-posts').innerText = posts.length;
                if (!document.getElementById('view-posts').classList.contains('hidden')) renderPostsTable();
                updateCharts();
            });

            // Comments
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'comments'), (snapshot) => {
                comments = [];
                const uniqueUsers = new Set();
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    comments.push({ id: doc.id, ...data });
                    if (data.user) uniqueUsers.add(data.user);
                });
                comments.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                document.getElementById('stats-total-comments').innerText = comments.length;
                document.getElementById('comment-badge').innerText = comments.length;
                document.getElementById('stats-unique-users').innerText = uniqueUsers.size;
                if (!document.getElementById('view-comments').classList.contains('hidden')) renderCommentsTable();
                updateCharts();
            });

            // Messages
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), (snapshot) => {
                messages = [];
                snapshot.forEach((doc) => messages.push({ id: doc.id, ...doc.data() }));
                messages.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                document.getElementById('stats-total-inbox').innerText = messages.length;
                const badge = document.getElementById('inbox-badge');
                if (messages.length > 0) { badge.innerText = messages.length; badge.classList.remove('hidden'); } 
                else { badge.classList.add('hidden'); }
                if (!document.getElementById('view-inbox').classList.contains('hidden')) renderInboxTable();
            });

            // Subscribers
             onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'subscribers'), (snapshot) => {
                subscribers = [];
                snapshot.forEach((doc) => subscribers.push({ id: doc.id, ...doc.data() }));
                subscribers.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                 if (!document.getElementById('view-subscribers').classList.contains('hidden')) renderSubscribersTable();
            });
            
            // Banners
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'banners'), (snapshot) => {
                banners = [];
                let activeCount = 0;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    banners.push({ id: doc.id, ...data });
                    if(data.active) activeCount++;
                });
                document.getElementById('stats-active-banners').innerText = activeCount;
                if (!document.getElementById('view-banners').classList.contains('hidden')) renderBannersTable();
            });
            
            // Logs (New)
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'audit_logs'), (snapshot) => {
                logs = [];
                snapshot.forEach((doc) => logs.push({ id: doc.id, ...doc.data() }));
                logs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                if (!document.getElementById('view-logs').classList.contains('hidden')) renderLogsTable();
            });

            // Analytics
             onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'analytics', 'main'), (doc) => {
                if (doc.exists()) document.getElementById('stats-total-views').innerText = (doc.data().totalViews || 0).toLocaleString();
            });
        }
        
        // --- HELPER: LOG ACTION ---
        window.logAction = async function(action, details, status = "Success") {
             await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'audit_logs'), {
                action, details, status, admin: "Super Admin", createdAt: serverTimestamp()
            });
        }
        
        // --- HELPER: EXPORT DATA ---
        window.exportData = function(type) {
            let data = [];
            let filename = `${type}_export.csv`;
            
            if(type === 'subscribers') data = subscribers;
            else if(type === 'backup') {
                // Combine all critical data for backup
                const backup = { posts, comments, subscribers, systemPrompts, apiKeys, banners };
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dsh_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                logAction('Export', 'Full Database Backup');
                return;
            }
            
            // CSV Logic
            if(data.length === 0) return alert("No data to export.");
            
            const headers = Object.keys(data[0]).join(",");
            const rows = data.map(row => Object.values(row).map(val => `"${val}"`).join(",")).join("\n");
            const csvContent = "data:text/csv;charset=utf-8," + headers + "\n" + rows;
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            logAction('Export', `Exported ${type} CSV`);
        }

        // --- RENDER FUNCTIONS ---

        function renderLogsTable() {
            const tbody = document.getElementById('logs-table-body');
            if (logs.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">No logs found.</td></tr>`; return; }
            tbody.innerHTML = logs.slice(0, 50).map(l => `
                <tr class="hover:bg-slate-50 transition-colors border-b border-slate-100">
                    <td class="px-6 py-4 font-medium text-slate-900"><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold">${l.action}</span></td>
                    <td class="px-6 py-4 text-slate-600 text-sm">${l.details}</td>
                    <td class="px-6 py-4 text-slate-500 text-sm">${l.admin}</td>
                    <td class="px-6 py-4 text-slate-400 text-xs">${l.createdAt ? new Date(l.createdAt.seconds * 1000).toLocaleString() : 'Just now'}</td>
                </tr>
            `).join('');
        }

        function renderInboxTable() {
            const tbody = document.getElementById('inbox-table-body');
            if (messages.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-slate-500">No messages.</td></tr>`; return; }
            tbody.innerHTML = messages.map(m => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 font-medium text-slate-900">${m.name}</td>
                    <td class="px-6 py-4 text-slate-600">${m.subject}</td>
                    <td class="px-6 py-4 text-slate-500 truncate max-w-xs">${m.message}</td>
                    <td class="px-6 py-4 text-slate-400 text-xs">${m.createdAt ? new Date(m.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-6 py-4 text-right">
                        <a href="mailto:${m.email}" class="text-brand-600 hover:text-brand-800 mr-3"><i data-lucide="reply" class="w-4 h-4 inline"></i></a>
                        <button onclick="deleteMessage('${m.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4 inline"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }
        window.deleteMessage = async function(id) { 
            if(confirm("Delete message?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'messages', id));
                logAction('Delete', 'Deleted inbox message');
            }
        }

        function renderSubscribersTable() {
            const tbody = document.getElementById('subscribers-table-body');
            if (subscribers.length === 0) { tbody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-slate-500">No subscribers yet.</td></tr>`; return; }
            tbody.innerHTML = subscribers.map(s => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 font-medium text-slate-900">${s.email}</td>
                    <td class="px-6 py-4 text-slate-600">${s.source || 'Blog'}</td>
                    <td class="px-6 py-4 text-slate-500">${s.createdAt ? new Date(s.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                </tr>
            `).join('');
        }

        function renderKeysTable() {
            const tbody = document.getElementById('keys-table-body');
            if (apiKeys.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">No keys found. Add one to start.</td></tr>`; return; }
            tbody.innerHTML = apiKeys.map(k => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 font-mono text-xs text-slate-600">${k.key.slice(-4)}</td>
                    <td class="px-6 py-4"><span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded-full">Active</span></td>
                    <td class="px-6 py-4 text-slate-500">${k.createdAt ? new Date(k.createdAt.seconds * 1000).toLocaleDateString() : 'N/A'}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="deleteKey('${k.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }
        window.addKeyPrompt = async function() {
            const key = prompt("Enter new Gemini API Key:");
            if (key && key.startsWith("AIza")) {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'api_keys'), { key: key, createdAt: serverTimestamp(), status: 'active' });
                logAction('Create', 'Added new API Key');
            } else if (key) alert("Invalid Key format.");
        }
        window.deleteKey = async function(id) { 
            if(confirm("Delete Key?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'api_keys', id));
                logAction('Delete', 'Deleted API Key');
            }
        }
        
        // Banners Logic
        function renderBannersTable() {
            const tbody = document.getElementById('banners-table-body');
            if (banners.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500">No banners created.</td></tr>`; return; }
            tbody.innerHTML = banners.map(b => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 font-medium text-slate-900">${b.text}</td>
                    <td class="px-6 py-4"><div class="w-6 h-6 rounded ${b.color}"></div></td>
                    <td class="px-6 py-4">
                         <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer toggle-checkbox" ${b.active ? 'checked' : ''} onchange="toggleBannerStatus('${b.id}', this.checked)">
                            <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="deleteBanner('${b.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }
        
        window.toggleBannerStatus = async function(id, isActive) {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'banners', id), { active: isActive });
            logAction('Update', `Toggled Banner ${isActive ? 'On' : 'Off'}`);
        }
        window.deleteBanner = async function(id) {
             if(confirm("Delete banner?")) {
                 await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'banners', id));
                 logAction('Delete', 'Deleted Banner');
             }
        }
        
        // Banner Modal
        const bannerModal = document.getElementById('banner-modal');
        const bannerModalContent = document.getElementById('banner-modal-content');
        
        window.openBannerModal = function() {
            bannerModal.classList.remove('hidden');
            setTimeout(() => { bannerModalContent.classList.remove('scale-95', 'opacity-0'); bannerModalContent.classList.add('scale-100', 'opacity-100'); }, 10);
            // Reset inputs
            document.getElementById('banner-text').value = '';
            document.getElementById('banner-link').value = '';
            document.getElementById('banner-active').checked = true;
        }
        window.closeBannerModal = function() {
            bannerModalContent.classList.remove('scale-100', 'opacity-100'); bannerModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => bannerModal.classList.add('hidden'), 200);
        }
        window.saveBanner = async function() {
            const text = document.getElementById('banner-text').value;
            const link = document.getElementById('banner-link').value;
            const color = document.getElementById('banner-color').value;
            const active = document.getElementById('banner-active').checked;
            
            if(!text) return alert("Banner text required");
            
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'banners'), {
                text, link, color, active, createdAt: serverTimestamp()
            });
            logAction('Create', 'Created new Ad Banner');
            closeBannerModal();
        }


        // Posts & Comments
        function renderPostsTable() {
            const tbody = document.getElementById('posts-table-body');
            if(posts.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-slate-500">No posts.</td></tr>`; return; }
            tbody.innerHTML = posts.map(p => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 font-medium">${p.title}</td>
                    <td class="px-6 py-4"><span class="bg-slate-100 text-slate-700 text-xs px-2 py-1 rounded-full">${p.category}</span></td>
                    <td class="px-6 py-4 text-slate-600">${p.author}</td>
                    <td class="px-6 py-4 text-slate-500">${p.date}</td>
                    <td class="px-6 py-4 text-right"><button onclick="openPostModal('${p.id}')" class="text-brand-600 mr-3">Edit</button><button onclick="deletePost('${p.id}')" class="text-red-500">Delete</button></td>
                </tr>`).join('');
        }
        window.deletePost = async function(id) { 
            if(confirm("Delete post?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', id));
                logAction('Delete', 'Deleted Blog Post');
            }
        }
        
        function renderCommentsTable() {
             const tbody = document.getElementById('comments-table-body');
            if(comments.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-slate-500">No comments.</td></tr>`; return; }
            tbody.innerHTML = comments.map(c => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 font-medium">${c.user || 'Anon'}</td>
                    <td class="px-6 py-4 text-slate-600 truncate max-w-xs">${c.text}</td>
                    <td class="px-6 py-4 text-slate-500">${c.date}</td>
                    <td class="px-6 py-4 text-right"><button onclick="deleteComment('${c.id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                </tr>`).join('');
            lucide.createIcons();
        }
        window.deleteComment = async function(id) { 
            if(confirm("Delete comment?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'comments', id));
                logAction('Delete', 'Deleted Comment');
            }
        }

        // Settings & SEO
        async function loadSettings() {
            try {
                const docSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // General & SEO
                    ['seo-title', 'seo-desc', 'seo-keywords', 'seo-author', 'seo-sitemap', 'seo-og-image', 'seo-robots', 'seo-scripts', 'seo-analytics-id', 'seo-search-console', 'ads-adsense'].forEach(id => {
                        const key = id.replace('seo-', '').replace('ads-', '').replace(/-([a-z])/g, g => g[1].toUpperCase());
                        if(id === 'seo-title') document.getElementById(id).value = data.title || '';
                        else if(id === 'seo-desc') document.getElementById(id).value = data.description || '';
                        else if(id === 'seo-analytics-id') document.getElementById(id).value = data.analyticsId || '';
                        else if(id === 'seo-search-console') document.getElementById(id).value = data.searchConsole || '';
                        else if(id === 'ads-adsense') document.getElementById(id).value = data.adsense || '';
                        else document.getElementById(id).value = data[key] || '';
                    });
                    
                    // Adsterra Sizes
                    ['160x300', '160x600', '300x250', '320x50', '728x90', '468x60'].forEach(size => {
                        const id = `ads-adsterra-${size}`;
                        document.getElementById(id).value = data.adsterra?.[size] || '';
                    });
                }
            } catch(e) { console.error(e); }
        }
        window.saveSettings = async function() {
            const btn = document.getElementById('save-settings-btn');
            btn.innerHTML = 'Saving...';
            
            const adsterra = {};
            ['160x300', '160x600', '300x250', '320x50', '728x90', '468x60'].forEach(size => {
                 adsterra[size] = document.getElementById(`ads-adsterra-${size}`).value;
            });

            const settings = {
                title: document.getElementById('seo-title').value,
                description: document.getElementById('seo-desc').value,
                keywords: document.getElementById('seo-keywords').value,
                author: document.getElementById('seo-author').value,
                sitemap: document.getElementById('seo-sitemap').value,
                ogImage: document.getElementById('seo-og-image').value,
                robots: document.getElementById('seo-robots').value,
                scripts: document.getElementById('seo-scripts').value,
                analyticsId: document.getElementById('seo-analytics-id').value,
                searchConsole: document.getElementById('seo-search-console').value,
                adsense: document.getElementById('ads-adsense').value,
                adsterra: adsterra,
                updatedAt: serverTimestamp()
            };
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), settings);
            logAction('Update', 'Updated Global SEO Settings');
            btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Saved';
            setTimeout(() => { btn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Save Settings'; lucide.createIcons(); }, 2000);
        }

        // Post Modal
        const modal = document.getElementById('post-modal');
        const modalContent = document.getElementById('post-modal-content');
        window.openPostModal = function(id=null) {
            modal.classList.remove('hidden');
            setTimeout(() => { modalContent.classList.remove('scale-95', 'opacity-0'); modalContent.classList.add('scale-100', 'opacity-100'); }, 10);
            if(id) {
                const p = posts.find(x => x.id === id);
                if(p) {
                    document.getElementById('modal-title').innerText = 'Edit Post';
                    document.getElementById('post-id').value = p.id;
                    document.getElementById('post-title').value = p.title;
                    document.getElementById('post-category').value = p.category;
                    document.getElementById('post-readTime').value = p.readTime;
                    document.getElementById('post-image').value = p.image;
                    document.getElementById('post-content').value = p.content;
                }
            } else {
                document.getElementById('modal-title').innerText = 'Create New Post';
                document.getElementById('post-id').value = '';
                document.getElementById('post-title').value = '';
                document.getElementById('post-content').value = '';
            }
        }
        window.closePostModal = function() {
            modalContent.classList.remove('scale-100', 'opacity-100'); modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }
        window.savePost = async function() {
            const id = document.getElementById('post-id').value;
            const data = {
                title: document.getElementById('post-title').value,
                category: document.getElementById('post-category').value,
                readTime: document.getElementById('post-readTime').value,
                image: document.getElementById('post-image').value,
                content: document.getElementById('post-content').value,
                author: "Admin",
                date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
                updatedAt: serverTimestamp()
            };
            if(id) {
                 await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', id), data);
                 logAction('Update', `Updated Post: ${data.title}`);
            } else { 
                data.createdAt = serverTimestamp(); 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), data); 
                logAction('Create', `Created Post: ${data.title}`);
            }
            closePostModal();
        }

        window.switchView = function(id) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
             document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('text-slate-300');
                if(btn.textContent.toLowerCase().includes(id.replace('prompts', 'ai prompts').replace('keys', 'api keys').replace('logs', 'audit logs'))) {
                    btn.classList.add('bg-slate-800', 'text-white');
                    btn.classList.remove('text-slate-300');
                }
            });
            if(id === 'dashboard') updateCharts();
            if(id === 'posts') renderPostsTable();
            if(id === 'comments') renderCommentsTable();
            if(id === 'inbox') renderInboxTable();
            if(id === 'subscribers') renderSubscribersTable();
            if(id === 'keys') renderKeysTable();
            if(id === 'banners') renderBannersTable();
            if(id === 'logs') renderLogsTable();
        }

        function renderPromptNav() {
            const nav = document.getElementById('prompts-nav'); nav.innerHTML = '';
            Object.keys(systemPrompts).forEach(key => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left px-3 py-2 rounded-md text-sm font-medium text-slate-600 hover:bg-brand-50 hover:text-brand-600 transition-colors`;
                btn.textContent = toolNames[key] || key;
                btn.onclick = () => {
                    currentPromptId = key;
                    document.getElementById('editor-title').innerText = toolNames[key] || key;
                    document.getElementById('prompt-editor').value = systemPrompts[key];
                };
                nav.appendChild(btn);
            });
        }
        window.saveAllPrompts = async function() {
            if(!currentPromptId) return;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'system_prompts', currentPromptId), { template: document.getElementById('prompt-editor').value });
            logAction('Update', `Updated Prompt: ${toolNames[currentPromptId]}`);
            alert("Saved!");
        }

        function updateCharts() {
            // Simplified for brevity in this merged response - assumes data exists
            if(activityChartInstance) activityChartInstance.destroy();
            if(contentChartInstance) contentChartInstance.destroy();
            // Re-init charts with current `posts` and `comments` data arrays
            const ctx1 = document.getElementById('activityChart').getContext('2d');
            activityChartInstance = new Chart(ctx1, { type: 'line', data: { labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'], datasets: [{ label: 'Posts', data: [posts.length, 0, 0, 0, 0, 0, 0] }] } });
        }

        window.logout = function() { window.location.href = 'login.html'; }
        document.getElementById('toggle-sidebar').addEventListener('click', () => { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebar').classList.toggle('absolute'); document.getElementById('sidebar').classList.toggle('h-full'); });
    </script>
</body>
</html>