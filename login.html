<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | DigitalServicesHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden animate-fade-in">
        
        <div class="p-8 pb-6 text-center">
            <div class="w-12 h-12 bg-brand-600 rounded-xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30">
                <i data-lucide="layout-grid" class="w-6 h-6 text-blue-600"></i>
            </div>
            <h1 class="text-2xl font-bold text-slate-900" id="page-title">Welcome Back</h1>
            <p class="text-slate-500 text-sm mt-2" id="page-desc">Enter your credentials to access the admin panel.</p>
        </div>

        <div class="px-8 mb-6">
            <button id="google-btn" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-300 text-slate-700 font-medium py-2.5 rounded-lg hover:bg-slate-50 transition-all hover:shadow-sm group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                <span class="group-hover:text-slate-900">Continue with Google</span>
            </button>
            <div class="relative my-6">
                <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-slate-400">Or continue with email</span></div>
            </div>
        </div>

        <form id="auth-form" class="px-8 pb-8 space-y-4">
            <div id="name-field" class="hidden">
                <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Full Name</label>
                <input type="text" id="name" placeholder="John Doe" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Email Address</label>
                <div class="relative">
                    <i data-lucide="mail" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                    <input type="email" id="email" required placeholder="admin@dsh.online" class="w-full pl-10 p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-1">
                    <label class="block text-xs font-bold text-slate-700 uppercase">Password</label>
                    <a href="#" id="forgot-password" class="text-xs text-blue-600 hover:underline">Forgot?</a>
                </div>
                <div class="relative">
                    <i data-lucide="lock" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                    <input type="password" id="password" required placeholder="••••••••" class="w-full pl-10 p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
            </div>

            <div id="error-msg" class="hidden bg-red-50 text-red-600 text-sm p-3 rounded-lg border border-red-100 flex items-start gap-2">
                <i data-lucide="alert-circle" class="w-4 h-4 mt-0.5 shrink-0"></i>
                <span id="error-text">Error message here</span>
            </div>

            <button type="submit" id="submit-btn" class="w-full bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700 transition-all shadow-lg shadow-blue-500/30 flex justify-center items-center gap-2">
                Sign In
            </button>
        </form>

        <div class="bg-slate-50 p-4 text-center border-t border-slate-200">
            <p class="text-sm text-slate-600" id="toggle-text">
                Don't have an account? 
                <button id="toggle-mode" class="text-blue-600 font-bold hover:underline">Create Account</button>
            </p>
        </div>
    </div>

    <script type="module">
        import { auth } from './assets/js/shared.js'; // Ensure this path is correct based on your file structure
        import { 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signInWithPopup, 
            GoogleAuthProvider,
            sendPasswordResetEmail,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Initialize Icons
        lucide.createIcons();

        // State
        let isLoginMode = true;

        // Elements
        const form = document.getElementById('auth-form');
        const googleBtn = document.getElementById('google-btn');
        const toggleBtn = document.getElementById('toggle-mode');
        const nameField = document.getElementById('name-field');
        const title = document.getElementById('page-title');
        const desc = document.getElementById('page-desc');
        const submitBtn = document.getElementById('submit-btn');
        const forgotBtn = document.getElementById('forgot-password');
        const errorBox = document.getElementById('error-msg');
        const errorText = document.getElementById('error-text');

        // 1. Toggle Login / Register
        toggleBtn.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            errorBox.classList.add('hidden'); // Clear errors
            
            if (isLoginMode) {
                title.innerText = "Welcome Back";
                desc.innerText = "Enter your credentials to access the admin panel.";
                submitBtn.innerText = "Sign In";
                nameField.classList.add('hidden');
                document.getElementById('name').required = false;
                toggleBtn.parentElement.innerHTML = `Don't have an account? <button id="toggle-mode" class="text-blue-600 font-bold hover:underline">Create Account</button>`;
                forgotBtn.classList.remove('hidden');
            } else {
                title.innerText = "Create Account";
                desc.innerText = "Join the team to manage the platform.";
                submitBtn.innerText = "Create Account";
                nameField.classList.remove('hidden');
                document.getElementById('name').required = true;
                toggleBtn.parentElement.innerHTML = `Already have an account? <button id="toggle-mode" class="text-blue-600 font-bold hover:underline">Sign In</button>`;
                forgotBtn.classList.add('hidden');
            }
            // Re-attach listener since we replaced innerHTML
            document.getElementById('toggle-mode').addEventListener('click', arguments.callee);
        });

        // 2. Handle Form Submit (Email/Pass)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const name = document.getElementById('name').value;

            setLoading(true);

            try {
                if (isLoginMode) {
                    // LOGIN
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    // SIGN UP
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    // Update Name
                    await updateProfile(userCredential.user, { displayName: name });
                }
                // Redirect on success
                window.location.href = "admin/index.html"; 
            } catch (error) {
                showError(parseError(error.code));
            } finally {
                setLoading(false);
            }
        });

        // 3. Handle Google Login
        googleBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                window.location.href = "admin/index.html";
            } catch (error) {
                console.error(error);
                showError("Google Sign-In failed. Please check your domain settings in Firebase Console.");
            }
        });

        // 4. Handle Forgot Password
        forgotBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            if (!email) return showError("Please enter your email address first.");
            
            try {
                await sendPasswordResetEmail(auth, email);
                alert("Password reset link sent to your email!");
            } catch (error) {
                showError(parseError(error.code));
            }
        });

        // Helpers
        function setLoading(isLoading) {
            if (isLoading) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = `<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Processing...`;
                lucide.createIcons();
            } else {
                submitBtn.disabled = false;
                submitBtn.innerText = isLoginMode ? "Sign In" : "Create Account";
            }
        }

        function showError(msg) {
            errorBox.classList.remove('hidden');
            errorText.innerText = msg;
        }

        function parseError(code) {
            switch (code) {
                case 'auth/invalid-credential': return "Incorrect email or password.";
                case 'auth/user-not-found': return "No account found with this email.";
                case 'auth/wrong-password': return "Incorrect password.";
                case 'auth/email-already-in-use': return "This email is already registered.";
                case 'auth/weak-password': return "Password should be at least 6 characters.";
                case 'auth/popup-closed-by-user': return "Sign-in cancelled.";
                default: return "An error occurred. Please try again.";
            }
        }
    </script>
</body>
</html>
